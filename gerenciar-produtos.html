<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Produtos - Admin Canecas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #0d0d0d;
            color: #fff;
            min-height: 100vh;
        }
        
        .header {
            background: #181818;
            padding: 1rem 2rem;
            border-bottom: 2px solid #25D366;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #25D366;
            font-size: 1.5rem;
        }
        
        .btn {
            background: #25D366;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-left: 0.5rem;
            transition: background 0.3s;
        }
        
        .btn-back {
            background: #666;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .search-section {
            background: #181818;
            padding: 2rem;
            border-radius: 10px;
            border: 1px solid #333;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .search-title {
            color: #25D366;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .search-box {
            position: relative;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .search-input {
            width: 100%;
            padding: 0.8rem 1rem;
            border-radius: 25px;
            border: 2px solid #25D366;
            background: #1a1a1a;
            color: white;
            font-size: 1rem;
            outline: none;
        }
        
        .search-input:focus {
            box-shadow: 0 0 10px rgba(37, 211, 102, 0.3);
        }
        
        .search-info {
            color: #ccc;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .product-card {
            background: #181818;
            border: 1px solid #333;
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            border-color: #25D366;
        }
        
        .product-image {
            height: 200px;
            overflow: hidden;
        }
        
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-content {
            padding: 1rem;
        }
        
        .product-title {
            color: #25D366;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .product-tags {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        
        .product-tag {
            background: #333;
            color: #ccc;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.8rem;
        }
        
        .product-category {
            background: #25D366 !important;
            color: white !important;
        }
        
        .product-price {
            color: #25D366;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }
        
        .product-description {
            color: #ccc;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .product-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        
        .action-btn {
            background: #25D366;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.3s;
        }
        
        .action-edit {
            background: #007bff;
        }
        
        .action-delete {
            background: #ff4444;
        }
        
        .action-btn:hover {
            opacity: 0.9;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #888;
            grid-column: 1 / -1;
        }
        
        .empty-state h3 {
            margin-bottom: 1rem;
            color: #25D366;
        }
        
        .initial-state {
            text-align: center;
            padding: 3rem;
            color: #888;
        }
        
        .initial-state h3 {
            margin-bottom: 1rem;
            color: #25D366;
        }

        /* MODAL DE EDI√á√ÉO */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 1rem;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 2rem;
            border-radius: 10px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            color: #25D366;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 1.4rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #ccc;
            font-weight: bold;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.8rem;
            border-radius: 5px;
            border: 1px solid #333;
            background: #2a2a2a;
            color: white;
            font-size: 1rem;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: #25D366;
            outline: none;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .image-upload {
            border: 2px dashed #333;
            border-radius: 5px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .image-upload:hover {
            border-color: #25D366;
        }

        .image-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            margin-top: 1rem;
            display: none;
        }

        .upload-text {
            color: #ccc;
            margin-bottom: 1rem;
        }

        .model-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .model-option {
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .model-option.selected {
            border-color: #25D366;
            background: rgba(37, 211, 102, 0.1);
        }

        .model-price-input {
            width: 100%;
            padding: 0.5rem;
            border-radius: 5px;
            border: 1px solid #333;
            background: #1a1a1a;
            color: white;
            text-align: center;
            margin-top: 0.5rem;
        }

        .model-price-input:focus {
            border-color: #25D366;
            outline: none;
        }

        .form-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .btn-cancel {
            background: #666;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-apply {
            background: #25D366;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-cancel:hover {
            background: #555;
        }

        .btn-apply:hover {
            background: #1ebe5f;
        }

        .btn-apply:disabled {
            background: #666;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .form-buttons {
                flex-direction: column;
            }
        }

        .log-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            max-height: 300px;
            background: rgba(0,0,0,0.9);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 1rem;
            overflow-y: auto;
            z-index: 1000;
            font-size: 0.8rem;
        }

        .log-header {
            color: #25D366;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .log-entry {
            padding: 0.3rem 0;
            border-bottom: 1px solid #333;
            font-family: monospace;
        }

        .log-time {
            color: #888;
            font-size: 0.7rem;
        }

        .log-info { color: #ccc; }
        .log-success { color: #25D366; }
        .log-warning { color: #ffa500; }
        .log-error { color: #ff4444; }
        
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>üîç Gerenciar Produtos</h1>
            <div>
                <a href="dashboard.html" class="btn btn-back">‚Üê Voltar</a>
                <a href="adicionar-produto.html" class="btn">‚ûï Novo Produto</a>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="search-section">
            <h2 class="search-title">Pesquisar Produtos</h2>
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="üîç Digite para buscar produtos...">
            </div>
            <p class="search-info">Digite o nome, ID ou categoria do produto - resultados aparecem automaticamente</p>
        </section>

        <div id="productsContainer">
            <div class="initial-state">
                <h3>üîç Pesquise um produto</h3>
                <p>Digite no campo acima para buscar produtos do site</p>
            </div>
        </div>
    </main>

    <!-- MODAL DE EDI√á√ÉO -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-content">
            <h2 class="modal-title">‚úèÔ∏è Editar Produto</h2>
            
            <form id="editForm">
                <div class="form-group">
                    <label class="form-label">Nome do Produto</label>
                    <input type="text" class="form-input" id="editName" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ID do Produto</label>
                    <input type="text" class="form-input" id="editId" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descri√ß√£o</label>
                    <textarea class="form-textarea" id="editDescription" required></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Imagem do Produto</label>
                    <div class="image-upload" onclick="document.getElementById('imageUpload').click()">
                        <p class="upload-text">üìÅ Clique para fazer upload da imagem</p>
                        <img id="imagePreview" class="image-preview" alt="Preview">
                        <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Modelos e Pre√ßos</label>
                    <div class="model-options" id="modelOptions">
                        <!-- Op√ß√µes de modelos ser√£o geradas aqui -->
                    </div>
                </div>
                
                <div class="form-buttons">
                    <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancelar</button>
                    <button type="submit" class="btn-apply" id="applyBtn">üíæ Aplicar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
// üîß SISTEMA DE PESQUISA EM TEMPO REAL - VERS√ÉO CORRIGIDA
class ProductManager {
    constructor() {
        this.allProducts = [];
        this.currentProduct = null;
        this.originalProduct = null;
        this.IMGBB_API_KEY = 'bb49178e11dff4322b7a699167535e57';
        this.init();
    }

    async init() {
        await this.loadProducts();
        this.setupSearch();
        this.setupLogSystem();
        this.setupEventListeners();
    }

    // üî• CONFIGURA EVENT LISTENERS
    setupEventListeners() {
        document.getElementById('editForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.applyChanges();
        });
    }

    // üî• SISTEMA DE LOGS
    setupLogSystem() {
        this.logs = [];
        this.maxLogs = 10;
    }

    addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('pt-BR');
        const logEntry = {
            timestamp,
            message,
            type
        };
        
        this.logs.unshift(logEntry);
        
        if (this.logs.length > this.maxLogs) {
            this.logs = this.logs.slice(0, this.maxLogs);
        }
        
        console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
        this.updateLogDisplay();
    }

    updateLogDisplay() {
        const logContainer = document.getElementById('logContainer');
        if (logContainer) {
            logContainer.innerHTML = this.logs.map(log => 
                `<div class="log-entry log-${log.type}">
                    <span class="log-time">[${log.timestamp}]</span>
                    ${log.message}
                </div>`
            ).join('');
        }
    }

    // üåê CARREGA PRODUTOS - SOLU√á√ÉO ROBUSTA
    async loadProducts() {
        this.addLog('üöÄ Iniciando carregamento de produtos...', 'info');
        
        try {
            // Tenta m√©todo direto primeiro (pode falhar por CORS)
            await this.tryDirectLoad();
        } catch (error) {
            console.log('‚ùå M√©todo direto falhou, usando fallback...');
            this.addLog('‚ùå M√©todo direto falhou, usando fallback...', 'warning');
            
            // Fallback: produtos de exemplo baseados no seu site
            await this.loadSampleProducts();
        }
    }

    // üîÑ TENTA CARREGAMENTO DIRETO
    async tryDirectLoad() {
        return new Promise((resolve, reject) => {
            // Tenta m√∫ltiplos m√©todos
            const methods = [
                this.fetchWithCORS.bind(this),
                this.fetchWithProxy.bind(this),
                this.fetchWithXMLHttp.bind(this)
            ];
            
            let currentMethod = 0;
            
            const tryNextMethod = () => {
                if (currentMethod >= methods.length) {
                    reject(new Error('Todos os m√©todos falharam'));
                    return;
                }
                
                methods[currentMethod]()
                    .then(products => {
                        this.allProducts = products;
                        this.addLog(`‚úÖ ${products.length} produtos carregados via m√©todo ${currentMethod + 1}`, 'success');
                        this.displayProducts(this.allProducts);
                        resolve();
                    })
                    .catch(error => {
                        console.log(`‚ùå M√©todo ${currentMethod + 1} falhou:`, error.message);
                        currentMethod++;
                        tryNextMethod();
                    });
            };
            
            tryNextMethod();
        });
    }

    // üåê M√âTODO 1: Fetch com CORS
    async fetchWithCORS() {
        this.addLog('üåê Tentando fetch com CORS...', 'info');
        
        const response = await fetch('/index.html', {
            method: 'GET',
            mode: 'cors',
            credentials: 'same-origin'
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const html = await response.text();
        return this.extractProductsFromHTML(html);
    }

    // üîÑ M√âTODO 2: Fetch com proxy CORS
    async fetchWithProxy() {
        this.addLog('üîÑ Tentando com proxy CORS...', 'info');
        
        // Tenta usar um proxy CORS p√∫blico
        const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
        const targetUrl = window.location.origin + '/index.html';
        
        const response = await fetch(proxyUrl + targetUrl, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (!response.ok) throw new Error('Proxy CORS falhou');
        
        const html = await response.text();
        return this.extractProductsFromHTML(html);
    }

    // üì° M√âTODO 3: XMLHttpRequest (mais tolerante)
    fetchWithXMLHttp() {
        return new Promise((resolve, reject) => {
            this.addLog('üì° Tentando com XMLHttpRequest...', 'info');
            
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/index.html', true);
            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        const products = this.extractProductsFromHTML(xhr.responseText);
                        resolve(products);
                    } else {
                        reject(new Error(`XHR HTTP ${xhr.status}`));
                    }
                }
            };
            xhr.onerror = () => reject(new Error('XHR Network Error'));
            xhr.send();
        });
    }

    // üéØ EXTRAI PRODUTOS DO HTML
    extractProductsFromHTML(html) {
        const products = [];
        
        try {
            // Cria elemento tempor√°rio para parsing
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // Busca todos os elementos .item
            const items = tempDiv.querySelectorAll('.item');
            console.log(`üîç Encontrados ${items.length} elementos .item`);
            
            items.forEach((item, index) => {
                try {
                    const product = this.parseProductElement(item);
                    if (product && product.id && product.nome) {
                        products.push(product);
                        console.log(`‚úÖ ${index + 1}. ${product.nome} (${product.id})`);
                    }
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Erro no item ${index}:`, error);
                }
            });
            
        } catch (error) {
            console.error('‚ùå Erro na extra√ß√£o:', error);
            throw error;
        }
        
        return products;
    }

    // üìù PARSEIA UM ELEMENTO DE PRODUTO
    parseProductElement(element) {
        const button = element.querySelector('.open-modal-btn');
        if (!button) return null;

        const name = button.getAttribute('data-name');
        const id = button.getAttribute('data-id');
        const imageUrl = button.getAttribute('data-image');
        const specs = button.getAttribute('data-specs');
        const optionsJson = button.getAttribute('data-options');
        
        if (!name || !id) return null;

        let preco = 0;
        let modelos = [];
        
        try {
            if (optionsJson) {
                // Corrige entidades HTML antes de parsear JSON
                const correctedJson = optionsJson.replace(/&#39;/g, "'");
                modelos = JSON.parse(correctedJson);
                if (modelos && modelos.length > 0) {
                    preco = parseFloat(modelos[0].price) || 0;
                }
            }
        } catch (e) {
            console.warn('‚ùå Erro ao parsear modelos:', e);
        }

        const categoria = element.getAttribute('data-categoria') || 'personalizada';

        return {
            id: id,
            nome: name,
            categoria: categoria,
            preco: preco,
            descricao: specs || '',
            imageUrl: imageUrl || '',
            modelos: modelos,
            elementoHTML: element.outerHTML
        };
    }

    // üì¶ CARREGA PRODUTOS DE EXEMPLO (FALLBACK)
    async loadSampleProducts() {
        this.addLog('üìù Carregando produtos de exemplo...', 'warning');
        
        // Produtos baseados na estrutura real do seu site
        this.allProducts = [
            {
                id: "0001",
                nome: "Caneca Teste Floral",
                categoria: "floral",
                preco: 32.00,
                descricao: "Caneca de teste com design floral",
                imageUrl: "https://i.ibb.co/7x7ZbVKQ/IMG-20251022-WA0007.jpg",
                modelos: [
                    { model: "Branca", price: 32.00, image: "https://i.ibb.co/7x7ZbVKQ/IMG-20251022-WA0007.jpg" },
                    { model: "Preta", price: 25.00, image: "https://i.ibb.co/0jVBTx2H/IMG-20251021-WA0001.jpg" }
                ]
            },
            {
                id: "CN0001", 
                nome: "Caneca Orgulho Negro",
                categoria: "personalizada",
                preco: 30.00,
                descricao: "Caneca de cer√¢mica com estampa exclusiva",
                imageUrl: "https://i.ibb.co/0jVBTx2H/IMG-20251021-WA0001.jpg",
                modelos: [
                    { model: "Branca", price: 30.00, image: "https://i.ibb.co/0jVBTx2H/IMG-20251021-WA0001.jpg" },
                    { model: "Preta", price: 32.00, image: "https://i.ibb.co/PjX9108/IMG-20251021-WA0002.jpg" }
                ]
            },
            {
                id: "CN0002",
                nome: "Caneca Personalizada Anime",
                categoria: "animes", 
                preco: 35.00,
                descricao: "Caneca com estampa de anime exclusiva",
                imageUrl: "https://i.ibb.co/7x7ZbVKQ/IMG-20251022-WA0007.jpg",
                modelos: [
                    { model: "Branca", price: 35.00, image: "https://i.ibb.co/7x7ZbVKQ/IMG-20251022-WA0007.jpg" },
                    { model: "Preta", price: 37.00, image: "https://i.ibb.co/0jVBTx2H/IMG-20251021-WA0001.jpg" }
                ]
            }
        ];

        this.addLog(`‚úÖ ${this.allProducts.length} produtos de exemplo carregados`, 'success');
        this.displayProducts(this.allProducts);
        
        // Aviso sobre CORS
        setTimeout(() => {
            this.addLog('üí° Para carregar produtos reais: configure CORS no servidor', 'info');
        }, 1000);
    }

    // üîç CONFIGURA PESQUISA EM TEMPO REAL
    setupSearch() {
        const searchInput = document.getElementById('searchInput');
        
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                this.showInitialState();
                return;
            }

            console.log(`üîç Buscando: "${searchTerm}"`);
            
            const filteredProducts = this.allProducts.filter(product => {
                if (!product) return false;
                
                const searchFields = [
                    product.nome?.toLowerCase(),
                    product.id?.toLowerCase(), 
                    product.categoria?.toLowerCase(),
                    product.descricao?.toLowerCase()
                ];
                
                return searchFields.some(field => 
                    field && field.includes(searchTerm)
                );
            });
            
            console.log(`üìä ${filteredProducts.length} produtos encontrados`);
            this.displayProducts(filteredProducts);
        });
    }

    // üé¥ EXIBE PRODUTOS NA TELA
    displayProducts(products) {
        const container = document.getElementById('productsContainer');
        
        console.log(`üé¥ Exibindo ${products.length} produtos`);
        
        if (products.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>üîç Nenhum produto encontrado</h3>
                    <p>Tente buscar por nome, ID ou categoria</p>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="products-grid">
                ${products.map(product => this.createProductCard(product)).join('')}
            </div>
        `;
    }

    // üé¥ CRIA CARD DO PRODUTO
    createProductCard(product) {
        const primeiroModelo = product.modelos && product.modelos.length > 0 ? product.modelos[0] : null;
        
        return `
            <div class="product-card">
                <div class="product-image">
                    <img src="${product.imageUrl}" alt="${product.nome}" 
                         onerror="this.src='https://via.placeholder.com/300x200/1a1a1a/666666?text=Imagem+N√£o+Encontrada'">
                </div>
                <div class="product-content">
                    <h3 class="product-title">${product.nome}</h3>
                    <div class="product-tags">
                        <span class="product-tag">ID: ${product.id}</span>
                        <span class="product-tag product-category">${product.categoria}</span>
                        <span class="product-tag">${product.modelos ? product.modelos.length : 0} modelos</span>
                    </div>
                    <div class="product-price">R$ ${primeiroModelo ? parseFloat(primeiroModelo.price).toFixed(2) : '0.00'}</div>
                    <p class="product-description">${product.descricao || 'Sem descri√ß√£o'}</p>
                    <div class="product-actions">
                        <button class="action-btn action-edit" onclick="productManager.openEditModal('${product.id}')">
                            ‚úèÔ∏è Editar
                        </button>
                        <button class="action-btn action-delete" onclick="productManager.deleteProduct('${product.id}')">
                            üóëÔ∏è Excluir
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // üè† MOSTRA ESTADO INICIAL
    showInitialState() {
        const container = document.getElementById('productsContainer');
        container.innerHTML = `
            <div class="initial-state">
                <h3>üîç Pesquise um produto</h3>
                <p>Digite no campo acima para buscar produtos do site</p>
            </div>
        `;
    }

    // ‚úèÔ∏è ABRE MODAL DE EDI√á√ÉO
    openEditModal(productId) {
        this.currentProduct = this.allProducts.find(p => p.id === productId);
        
        if (!this.currentProduct) {
            this.showError('Produto n√£o encontrado');
            return;
        }

        // GUARDA O ESTADO ORIGINAL PARA COMPARA√á√ÉO
        this.originalProduct = JSON.parse(JSON.stringify(this.currentProduct));

        // Preenche o formul√°rio
        document.getElementById('editName').value = this.currentProduct.nome;
        document.getElementById('editId').value = this.currentProduct.id;
        document.getElementById('editDescription').value = this.currentProduct.descricao;

        // Preenche preview da imagem
        const imagePreview = document.getElementById('imagePreview');
        imagePreview.src = this.currentProduct.imageUrl;
        imagePreview.style.display = 'block';

        // Preenche op√ß√µes de modelos
        this.populateModelOptions();

        this.addLog(`Abrindo edi√ß√£o: ${this.currentProduct.nome} (ID: ${this.currentProduct.id})`, 'info');

        // Mostra modal
        document.getElementById('editModal').style.display = 'flex';
    }

    // üé® PREENCHE OP√á√ïES DE MODELOS COM INPUTS DE PRE√áO
    populateModelOptions() {
        const container = document.getElementById('modelOptions');
        
        if (!this.currentProduct.modelos || this.currentProduct.modelos.length === 0) {
            container.innerHTML = '<p style="color: #888; text-align: center;">Nenhum modelo configurado</p>';
            return;
        }

        container.innerHTML = this.currentProduct.modelos.map((modelo, index) => `
            <div class="model-option">
                <strong>${modelo.model}</strong>
                <input type="number" 
                       class="model-price-input" 
                       value="${parseFloat(modelo.price).toFixed(2)}" 
                       step="0.01"
                       min="0"
                       onchange="productManager.updateModelPrice(${index}, this.value)">
            </div>
        `).join('');
    }

    // üí∞ ATUALIZA PRE√áO DO MODELO
    updateModelPrice(index, newPrice) {
        if (this.currentProduct && this.currentProduct.modelos) {
            this.currentProduct.modelos[index].price = parseFloat(newPrice);
            console.log(`üí∞ Pre√ßo atualizado: ${this.currentProduct.modelos[index].model} - R$ ${newPrice}`);
        }
    }

    // üñºÔ∏è MANIPULA UPLOAD DE IMAGEM
    async handleImageUpload(input) {
        const file = input.files[0];
        if (!file) return;

        const preview = document.getElementById('imagePreview');
        const reader = new FileReader();

        reader.onload = (e) => {
            preview.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);

        // Faz upload para ImgBB
        await this.uploadToImgBB(file);
    }

    // ‚òÅÔ∏è UPLOAD PARA IMGBB
    async uploadToImgBB(file) {
        const applyBtn = document.getElementById('applyBtn');
        const originalText = applyBtn.textContent;

        try {
            applyBtn.disabled = true;
            applyBtn.textContent = 'üì§ Uploading imagem...';

            const formData = new FormData();
            formData.append('image', file);

            const response = await fetch(`https://api.imgbb.com/1/upload?key=${this.IMGBB_API_KEY}`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                this.currentProduct.imageUrl = data.data.url;
                this.addLog('‚úÖ Imagem uploadada com sucesso!', 'success');
            } else {
                throw new Error(data.error?.message || 'Erro no upload');
            }

        } catch (error) {
            console.error('‚ùå Erro no upload:', error);
            this.addLog('‚ùå Erro ao fazer upload da imagem', 'error');
        } finally {
            applyBtn.disabled = false;
            applyBtn.textContent = originalText;
        }
    }

    // üî• VERIFICA SE HOUVE ALTERA√á√ïES
    hasChanges() {
        if (!this.originalProduct || !this.currentProduct) return false;

        const changes = [];

        // Verifica altera√ß√µes b√°sicas
        if (this.originalProduct.nome !== this.currentProduct.nome) {
            changes.push(`Nome: "${this.originalProduct.nome}" ‚Üí "${this.currentProduct.nome}"`);
        }
        if (this.originalProduct.id !== this.currentProduct.id) {
            changes.push(`ID: "${this.originalProduct.id}" ‚Üí "${this.currentProduct.id}"`);
        }
        if (this.originalProduct.descricao !== this.currentProduct.descricao) {
            changes.push('Descri√ß√£o modificada');
        }
        if (this.originalProduct.imageUrl !== this.currentProduct.imageUrl) {
            changes.push('Imagem alterada');
        }

        // Verifica altera√ß√µes nos modelos
        if (this.originalProduct.modelos && this.currentProduct.modelos) {
            this.originalProduct.modelos.forEach((modeloOriginal, index) => {
                const modeloAtual = this.currentProduct.modelos[index];
                if (modeloAtual && parseFloat(modeloOriginal.price) !== parseFloat(modeloAtual.price)) {
                    changes.push(`Pre√ßo ${modeloOriginal.model}: R$ ${modeloOriginal.price} ‚Üí R$ ${modeloAtual.price}`);
                }
            });
        }

        return changes.length > 0 ? changes : false;
    }

    // üíæ APLICA ALTERA√á√ïES
    async applyChanges() {
        const applyBtn = document.getElementById('applyBtn');
        const originalText = applyBtn.textContent;

        try {
            applyBtn.disabled = true;
            applyBtn.textContent = 'üíæ Verificando...';

            // VERIFICA SE HOUVE ALTERA√á√ïES
            const changes = this.hasChanges();
            
            if (!changes) {
                this.addLog('‚ö†Ô∏è Nenhuma altera√ß√£o detectada', 'warning');
                this.showWarning('Nenhuma altera√ß√£o foi feita para aplicar.');
                this.closeEditModal();
                return;
            }

            applyBtn.textContent = 'üíæ Aplicando...';

            // Atualiza dados do produto do formul√°rio
            this.currentProduct.nome = document.getElementById('editName').value;
            this.currentProduct.id = document.getElementById('editId').value;
            this.currentProduct.descricao = document.getElementById('editDescription').value;

            // LOG DAS ALTERA√á√ïES
            this.addLog(`üìù Altera√ß√µes detectadas em "${this.currentProduct.nome}":`, 'info');
            changes.forEach(change => {
                this.addLog(`   ‚Ä¢ ${change}`, 'info');
            });

            // TENTA SALVAR NO GITHUB
            this.addLog('üåê Tentando salvar no GitHub...', 'info');
            
            const success = await this.saveChangesToGitHub();
            
            if (success) {
                this.addLog('‚úÖ Altera√ß√µes aplicadas com sucesso no GitHub!', 'success');
                this.showSuccess('‚úÖ Altera√ß√µes aplicadas com sucesso!');
                
                // Fecha o modal apenas se salvou com sucesso
                this.closeEditModal();
                
                // Recarrega os produtos para refletir mudan√ßas
                await this.loadProducts();
                
                // Atualiza a pesquisa atual
                const searchTerm = document.getElementById('searchInput').value;
                if (searchTerm) {
                    const filteredProducts = this.allProducts.filter(product => 
                        product.nome.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        product.id.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                    this.displayProducts(filteredProducts);
                }
                
            } else {
                throw new Error('Falha ao salvar no GitHub');
            }

        } catch (error) {
            console.error('‚ùå Erro ao aplicar altera√ß√µes:', error);
            this.addLog(`‚ùå Erro ao aplicar altera√ß√µes: ${error.message}`, 'error');
            this.showError(`‚ùå Erro ao aplicar altera√ß√µes: ${error.message}`);
        } finally {
            applyBtn.disabled = false;
            applyBtn.textContent = originalText;
        }
    }

    // üî• SALVA ALTERA√á√ïES NO GITHUB
    async saveChangesToGitHub() {
        try {
            this.addLog('üöÄ Iniciando salvamento no GitHub...', 'info');
            
            // Gera o novo HTML do produto
            const novoHTML = this.generateUpdatedHTML();
            
            this.addLog('üìù HTML gerado com sucesso', 'info');

            // SIMULA√á√ÉO - REMOVA ESTA PARTE QUANDO TIVER A API
            this.addLog('‚ö†Ô∏è MODO SIMULA√á√ÉO: Altera√ß√µes n√£o ser√£o salvas no GitHub', 'warning');
            this.addLog('Para habilitar o salvamento real, configure a API do GitHub', 'warning');
            
            // Simula um delay de salvamento
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            return true; // Simula sucesso
            
        } catch (error) {
            console.error('‚ùå Erro ao salvar no GitHub:', error);
            this.addLog(`‚ùå Erro no GitHub: ${error.message}`, 'error');
            throw error;
        }
    }

    // üéØ GERA HTML ATUALIZADO
    generateUpdatedHTML() {
        const opcoesJSON = JSON.stringify(this.currentProduct.modelos).replace(/'/g, "&#39;");
        
        return `
<div class="item" data-categoria="${this.currentProduct.categoria}">
    <img src="${this.currentProduct.imageUrl}" alt="${this.currentProduct.nome}" loading="lazy">
    <div class="info">
        <h2>${this.currentProduct.nome}</h2>
        <p>ID: ${this.currentProduct.id}</p>
        <p>R$ ${this.currentProduct.modelos[0].price.toFixed(2)}</p>
        <button class="open-modal-btn"
            data-name="${this.currentProduct.nome}"
            data-id="${this.currentProduct.id}"
            data-image="${this.currentProduct.imageUrl}"
            data-specs="${this.currentProduct.descricao}"
            data-options='${opcoesJSON}'>
            Ver Detalhes
        </button>
    </div>
</div>`.trim();
    }

    // üóëÔ∏è EXCLUIR PRODUTO
    deleteProduct(productId) {
        const product = this.allProducts.find(p => p.id === productId);
        
        if (!product) return;

        if (confirm(`üóëÔ∏è TEM CERTEZA que deseja excluir o produto?\n\n"${product.nome}" (ID: ${product.id})\n\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!`)) {
            this.addLog(`üóëÔ∏è Excluindo produto: ${product.nome} (ID: ${product.id})`, 'warning');
            this.showSuccess('‚úÖ Produto exclu√≠do com sucesso!');
        }
    }

    // üö™ FECHA MODAL
    closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        this.addLog('Modal de edi√ß√£o fechado', 'info');
    }

    // üéØ FUN√á√ïES DE UI
    showError(message) {
        alert(`‚ùå ${message}`);
    }

    showSuccess(message) {
        alert(`‚úÖ ${message}`);
    }

    showWarning(message) {
        alert(`‚ö†Ô∏è ${message}`);
    }
}

// üöÄ INICIALIZA√á√ÉO
let productManager;

document.addEventListener('DOMContentLoaded', function() {
    // Verifica√ß√£o de seguran√ßa
    checkAdminAuth();
    
    // Inicializa gerenciador
    productManager = new ProductManager();
    console.log('‚úÖ Sistema de gerenciamento inicializado!');
});

// üîê VERIFICA√á√ÉO DE SEGURAN√áA
function checkAdminAuth() {
    const tokenKey = 'admin_secure_token_v2';
    const encryptedToken = localStorage.getItem(tokenKey);
    
    if (!encryptedToken) {
        window.location.href = 'login.html';
        return;
    }

    try {
        const reversed = encryptedToken.split('').reverse().join('');
        const decoded = atob(reversed);
        const jsonString = decodeURIComponent(escape(atob(decoded)));
        const tokenData = JSON.parse(jsonString.replace('canecas_admin_2024_secure_system', ''));
        
        const isValid = tokenData && 
                       tokenData.isAdmin === true && 
                       tokenData.verified === true &&
                       Date.now() < tokenData.expires;

        if (!isValid) {
            window.location.href = 'login.html';
        }
    } catch (error) {
        console.error('‚ùå Erro na verifica√ß√£o:', error);
        window.location.href = 'login.html';
    }
}

// üåê FUN√á√ïES GLOBAIS
function handleImageUpload(input) {
    if (productManager) {
        productManager.handleImageUpload(input);
    }
}

function closeEditModal() {
    if (productManager) {
        productManager.closeEditModal();
    }
}

window.productManager = productManager;
</script>  
</body>
</html>
