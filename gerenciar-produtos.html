<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Produtos - Admin Canecas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #0d0d0d;
            color: #fff;
            min-height: 100vh;
        }
        
        .header {
            background: #181818;
            padding: 1rem 2rem;
            border-bottom: 2px solid #25D366;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #25D366;
            font-size: 1.5rem;
        }
        
        .btn {
            background: #25D366;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-left: 0.5rem;
            transition: background 0.3s;
        }
        
        .btn-back {
            background: #666;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .search-section {
            background: #181818;
            padding: 2rem;
            border-radius: 10px;
            border: 1px solid #333;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .search-title {
            color: #25D366;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .search-box {
            position: relative;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .search-input {
            width: 100%;
            padding: 0.8rem 1rem;
            border-radius: 25px;
            border: 2px solid #25D366;
            background: #1a1a1a;
            color: white;
            font-size: 1rem;
            outline: none;
        }
        
        .search-input:focus {
            box-shadow: 0 0 10px rgba(37, 211, 102, 0.3);
        }
        
        .search-info {
            color: #ccc;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .product-card {
            background: #181818;
            border: 1px solid #333;
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            border-color: #25D366;
        }
        
        .product-image {
            height: 200px;
            overflow: hidden;
        }
        
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-content {
            padding: 1rem;
        }
        
        .product-title {
            color: #25D366;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .product-tags {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        
        .product-tag {
            background: #333;
            color: #ccc;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.8rem;
        }
        
        .product-category {
            background: #25D366 !important;
            color: white !important;
        }
        
        .product-price {
            color: #25D366;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }
        
        .product-description {
            color: #ccc;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .product-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        
        .action-btn {
            background: #25D366;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.3s;
        }
        
        .action-edit {
            background: #007bff;
        }
        
        .action-delete {
            background: #ff4444;
        }
        
        .action-btn:hover {
            opacity: 0.9;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #888;
            grid-column: 1 / -1;
        }
        
        .empty-state h3 {
            margin-bottom: 1rem;
            color: #25D366;
        }
        
        .initial-state {
            text-align: center;
            padding: 3rem;
            color: #888;
        }
        
        .initial-state h3 {
            margin-bottom: 1rem;
            color: #25D366;
        }

        /* MODAL DE EDI√á√ÉO */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 1rem;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 2rem;
            border-radius: 10px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            color: #25D366;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 1.4rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #ccc;
            font-weight: bold;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.8rem;
            border-radius: 5px;
            border: 1px solid #333;
            background: #2a2a2a;
            color: white;
            font-size: 1rem;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: #25D366;
            outline: none;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .image-upload {
            border: 2px dashed #333;
            border-radius: 5px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .image-upload:hover {
            border-color: #25D366;
        }

        .image-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            margin-top: 1rem;
            display: none;
        }

        .upload-text {
            color: #ccc;
            margin-bottom: 1rem;
        }

        .model-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .model-option {
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .model-option.selected {
            border-color: #25D366;
            background: rgba(37, 211, 102, 0.1);
        }

        .model-price-input {
            width: 100%;
            padding: 0.5rem;
            border-radius: 5px;
            border: 1px solid #333;
            background: #1a1a1a;
            color: white;
            text-align: center;
            margin-top: 0.5rem;
        }

        .model-price-input:focus {
            border-color: #25D366;
            outline: none;
        }

        .form-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .btn-cancel {
            background: #666;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-apply {
            background: #25D366;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-cancel:hover {
            background: #555;
        }

        .btn-apply:hover {
            background: #1ebe5f;
        }

        .btn-apply:disabled {
            background: #666;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .form-buttons {
                flex-direction: column;
            }
        }
        



.log-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 400px;
    max-height: 300px;
    background: rgba(0,0,0,0.9);
    border: 1px solid #333;
    border-radius: 10px;
    padding: 1rem;
    overflow-y: auto;
    z-index: 1000;
    font-size: 0.8rem;
}

.log-header {
    color: #25D366;
    margin-bottom: 0.5rem;
    font-weight: bold;
}

.log-entry {
    padding: 0.3rem 0;
    border-bottom: 1px solid #333;
    font-family: monospace;
}

.log-time {
    color: #888;
    font-size: 0.7rem;
}

.log-info { color: #ccc; }
.log-success { color: #25D366; }
.log-warning { color: #ffa500; }
.log-error { color: #ff4444; }
        
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>üîç Gerenciar Produtos</h1>
            <div>
                <a href="dashboard.html" class="btn btn-back">‚Üê Voltar</a>
                <a href="adicionar-produto.html" class="btn">‚ûï Novo Produto</a>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="search-section">
            <h2 class="search-title">Pesquisar Produtos</h2>
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="üîç Digite para buscar produtos...">
            </div>
            <p class="search-info">Digite o nome, ID ou categoria do produto - resultados aparecem automaticamente</p>
        </section>

        <div id="productsContainer">
            <div class="initial-state">
                <h3>üîç Pesquise um produto</h3>
                <p>Digite no campo acima para buscar produtos do site</p>
            </div>
        </div>
    </main>

    <!-- MODAL DE EDI√á√ÉO -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-content">
            <h2 class="modal-title">‚úèÔ∏è Editar Produto</h2>
            
            <form id="editForm">
                <div class="form-group">
                    <label class="form-label">Nome do Produto</label>
                    <input type="text" class="form-input" id="editName" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ID do Produto</label>
                    <input type="text" class="form-input" id="editId" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descri√ß√£o</label>
                    <textarea class="form-textarea" id="editDescription" required></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Imagem do Produto</label>
                    <div class="image-upload" onclick="document.getElementById('imageUpload').click()">
                        <p class="upload-text">üìÅ Clique para fazer upload da imagem</p>
                        <img id="imagePreview" class="image-preview" alt="Preview">
                        <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Modelos e Pre√ßos</label>
                    <div class="model-options" id="modelOptions">
                        <!-- Op√ß√µes de modelos ser√£o geradas aqui -->
                    </div>
                </div>
                
                <div class="form-buttons">
                    <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancelar</button>
                    <button type="submit" class="btn-apply" id="applyBtn">üíæ Aplicar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
  // üîß SISTEMA DE PESQUISA EM TEMPO REAL
class ProductManager {
    constructor() {
        this.allProducts = [];
        this.currentProduct = null;
        this.originalProduct = null; // üî• NOVO: Guarda o estado original
        this.IMGBB_API_KEY = 'bb49178e11dff4322b7a699167535e57';
        this.init();
    }

    async init() {
        await this.loadProductsFromSite();
        this.setupSearch();
        this.showInitialState();
        this.setupLogSystem(); // üî• NOVO: Sistema de logs
    }

    // üî• NOVO: SISTEMA DE LOGS
    setupLogSystem() {
        this.logs = [];
        this.maxLogs = 10;
    }

    addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('pt-BR');
        const logEntry = {
            timestamp,
            message,
            type
        };
        
        this.logs.unshift(logEntry);
        
        // Mant√©m apenas os √∫ltimos logs
        if (this.logs.length > this.maxLogs) {
            this.logs = this.logs.slice(0, this.maxLogs);
        }
        
        console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
        this.updateLogDisplay();
    }

    updateLogDisplay() {
        const logContainer = document.getElementById('logContainer');
        if (logContainer) {
            logContainer.innerHTML = this.logs.map(log => 
                `<div class="log-entry log-${log.type}">
                    <span class="log-time">[${log.timestamp}]</span>
                    ${log.message}
                </div>`
            ).join('');
        }
    }

    // üåê CARREGA PRODUTOS DO SITE
    async loadProductsFromSite() {
        try {
            this.addLog('Carregando produtos do site...', 'info');
            
            const response = await fetch('index.html');
            const html = await response.text();
            
            this.allProducts = this.extractProductsFromHTML(html);
            this.addLog(`‚úÖ ${this.allProducts.length} produtos carregados`, 'success');
            
        } catch (error) {
            console.error('‚ùå Erro ao carregar produtos:', error);
            this.addLog('‚ùå Erro ao carregar produtos do site', 'error');
        }
    }

    // ‚úèÔ∏è ABRE MODAL DE EDI√á√ÉO - CORRIGIDO
    openEditModal(productId) {
        this.currentProduct = this.allProducts.find(p => p.id === productId);
        
        if (!this.currentProduct) {
            this.showError('Produto n√£o encontrado');
            return;
        }

        // üî• GUARDA O ESTADO ORIGINAL PARA COMPARA√á√ÉO
        this.originalProduct = JSON.parse(JSON.stringify(this.currentProduct));

        // Preenche o formul√°rio
        document.getElementById('editName').value = this.currentProduct.nome;
        document.getElementById('editId').value = this.currentProduct.id;
        document.getElementById('editDescription').value = this.currentProduct.descricao;

        // Preenche preview da imagem
        const imagePreview = document.getElementById('imagePreview');
        imagePreview.src = this.currentProduct.imageUrl;
        imagePreview.style.display = 'block';

        // Preenche op√ß√µes de modelos
        this.populateModelOptions();

        this.addLog(`Abrindo edi√ß√£o: ${this.currentProduct.nome} (ID: ${this.currentProduct.id})`, 'info');

        // Mostra modal
        document.getElementById('editModal').style.display = 'flex';
    }

    // üî• NOVO: VERIFICA SE HOUVE ALTERA√á√ïES
    hasChanges() {
        if (!this.originalProduct || !this.currentProduct) return false;

        const changes = [];

        // Verifica altera√ß√µes b√°sicas
        if (this.originalProduct.nome !== this.currentProduct.nome) {
            changes.push(`Nome: "${this.originalProduct.nome}" ‚Üí "${this.currentProduct.nome}"`);
        }
        if (this.originalProduct.id !== this.currentProduct.id) {
            changes.push(`ID: "${this.originalProduct.id}" ‚Üí "${this.currentProduct.id}"`);
        }
        if (this.originalProduct.descricao !== this.currentProduct.descricao) {
            changes.push('Descri√ß√£o modificada');
        }
        if (this.originalProduct.imageUrl !== this.currentProduct.imageUrl) {
            changes.push('Imagem alterada');
        }

        // Verifica altera√ß√µes nos modelos
        if (this.originalProduct.modelos && this.currentProduct.modelos) {
            this.originalProduct.modelos.forEach((modeloOriginal, index) => {
                const modeloAtual = this.currentProduct.modelos[index];
                if (modeloAtual && parseFloat(modeloOriginal.price) !== parseFloat(modeloAtual.price)) {
                    changes.push(`Pre√ßo ${modeloOriginal.model}: R$ ${modeloOriginal.price} ‚Üí R$ ${modeloAtual.price}`);
                }
            });
        }

        return changes.length > 0 ? changes : false;
    }

    // üíæ APLICA ALTERA√á√ïES - CORRIGIDO
    async applyChanges() {
        const applyBtn = document.getElementById('applyBtn');
        const originalText = applyBtn.textContent;

        try {
            applyBtn.disabled = true;
            applyBtn.textContent = 'üíæ Verificando...';

            // üî• VERIFICA SE HOUVE ALTERA√á√ïES
            const changes = this.hasChanges();
            
            if (!changes) {
                this.addLog('‚ö†Ô∏è Nenhuma altera√ß√£o detectada', 'warning');
                this.showWarning('Nenhuma altera√ß√£o foi feita para aplicar.');
                this.closeEditModal();
                return;
            }

            applyBtn.textContent = 'üíæ Aplicando...';

            // Atualiza dados do produto do formul√°rio
            this.currentProduct.nome = document.getElementById('editName').value;
            this.currentProduct.id = document.getElementById('editId').value;
            this.currentProduct.descricao = document.getElementById('editDescription').value;

            // üî• LOG DAS ALTERA√á√ïES
            this.addLog(`üìù Altera√ß√µes detectadas em "${this.currentProduct.nome}":`, 'info');
            changes.forEach(change => {
                this.addLog(`   ‚Ä¢ ${change}`, 'info');
            });

            // üî• TENTA SALVAR NO GITHUB
            this.addLog('üåê Tentando salvar no GitHub...', 'info');
            
            const success = await this.saveChangesToGitHub();
            
            if (success) {
                this.addLog('‚úÖ Altera√ß√µes aplicadas com sucesso no GitHub!', 'success');
                this.showSuccess('‚úÖ Altera√ß√µes aplicadas com sucesso!');
                
                // Fecha o modal apenas se salvou com sucesso
                this.closeEditModal();
                
                // Recarrega os produtos para refletir mudan√ßas
                await this.loadProductsFromSite();
                
                // Atualiza a pesquisa atual
                const searchTerm = document.getElementById('searchInput').value;
                if (searchTerm) {
                    const filteredProducts = this.allProducts.filter(product => 
                        product.nome.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        product.id.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                    this.displayProducts(filteredProducts);
                }
                
            } else {
                throw new Error('Falha ao salvar no GitHub');
            }

        } catch (error) {
            console.error('‚ùå Erro ao aplicar altera√ß√µes:', error);
            this.addLog(`‚ùå Erro ao aplicar altera√ß√µes: ${error.message}`, 'error');
            this.showError(`‚ùå Erro ao aplicar altera√ß√µes: ${error.message}`);
        } finally {
            applyBtn.disabled = false;
            applyBtn.textContent = originalText;
        }
    }

    // üî• SALVA ALTERA√á√ïES NO GITHUB - CORRIGIDO
    async saveChangesToGitHub() {
        try {
            this.addLog('üöÄ Iniciando salvamento no GitHub...', 'info');
            
            // Gera o novo HTML do produto
            const novoHTML = this.generateUpdatedHTML();
            
            this.addLog('üìù HTML gerado com sucesso', 'info');

            // üî• SIMULA√á√ÉO - REMOVA ESTA PARTE QUANDO TIVER A API
            this.addLog('‚ö†Ô∏è MODO SIMULA√á√ÉO: Altera√ß√µes n√£o ser√£o salvas no GitHub', 'warning');
            this.addLog('Para habilitar o salvamento real, configure a API do GitHub', 'warning');
            
            // Simula um delay de salvamento
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // üî• COMENTE A LINHA ACIMA E DESCOMENTE ESTA PARTE QUANDO TIVER A API:
            /*
            const response = await fetch('/api/github-update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    htmlCode: novoHTML,
                    commitMessage: `‚úèÔ∏è Atualizar produto: ${this.currentProduct.nome} (ID: ${this.currentProduct.id})`
                })
            });

            const data = await response.json();
            
            if (data.success) {
                this.addLog('‚úÖ Altera√ß√µes salvas no GitHub com sucesso!', 'success');
                return true;
            } else {
                throw new Error(data.error || 'Erro do GitHub');
            }
            */
            
            // üî• REMOVA ESTA LINHA QUANDO TIVER A API:
            return true; // Simula sucesso
            
        } catch (error) {
            console.error('‚ùå Erro ao salvar no GitHub:', error);
            this.addLog(`‚ùå Erro no GitHub: ${error.message}`, 'error');
            throw error;
        }
    }

    // üéØ GERA HTML ATUALIZADO
    generateUpdatedHTML() {
        const opcoesJSON = JSON.stringify(this.currentProduct.modelos).replace(/'/g, "&#39;");
        
        return `
<div class="item" data-categoria="${this.currentProduct.categoria}">
    <img src="${this.currentProduct.imageUrl}" alt="${this.currentProduct.nome}" loading="lazy">
    <div class="info">
        <h2>${this.currentProduct.nome}</h2>
        <p>ID: ${this.currentProduct.id}</p>
        <p>R$ ${this.currentProduct.modelos[0].price.toFixed(2)}</p>
        <button class="open-modal-btn"
            data-name="${this.currentProduct.nome}"
            data-id="${this.currentProduct.id}"
            data-image="${this.currentProduct.imageUrl}"
            data-specs="${this.currentProduct.descricao}"
            data-options='${opcoesJSON}'>
            Ver Detalhes
        </button>
    </div>
</div>`.trim();
    }

    // üö™ FECHA MODAL - CORRIGIDO
    closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        this.addLog('Modal de edi√ß√£o fechado', 'info');
    }

    // üéØ FUN√á√ïES DE UI ADICIONAIS
    showWarning(message) {
        alert(`‚ö†Ô∏è ${message}`);
    }
}  </script>
</body>
</html>
