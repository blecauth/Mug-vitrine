<script>
    // DASHBOARD COM GITHUB REAL
    console.log('üöÄ Iniciando dashboard com GitHub...');

    class GitHubDashboard {
        constructor() {
            this.products = [];
            this.currentEditingProduct = null;
        }

        async init() {
            console.log('üì° Iniciando carregamento do GitHub...');
            await this.carregarProdutosDoGitHub();
        }

        async carregarProdutosDoGitHub() {
            try {
                console.log('üåê Conectando com GitHub...');
                
                // Tenta a API primeiro
                let htmlContent;
                try {
                    const response = await fetch('/api/github-read');
                    const data = await response.json();
                    
                    if (data.success) {
                        htmlContent = data.content;
                        console.log('‚úÖ API GitHub funcionando!');
                    } else {
                        throw new Error('API retornou erro');
                    }
                } catch (apiError) {
                    console.log('‚ùå API n√£o dispon√≠vel, usando fallback...');
                    // Fallback: carrega do site principal
                    const response = await fetch('/');
                    htmlContent = await response.text();
                }
                
                this.products = this.extrairProdutosDoHTML(htmlContent);
                console.log(`üì¶ Encontrados ${this.products.length} produtos`);
                
                this.exibirProdutos(this.products);
                this.loadStats();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar produtos:', error);
                this.mostrarErro('Erro ao carregar produtos: ' + error.message);
            }
        }

        extrairProdutosDoHTML(htmlContent) {
            const products = [];
            
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                const productCards = doc.querySelectorAll('.item');
                console.log(`üéØ Encontrados ${productCards.length} elementos .item`);

                productCards.forEach((card, index) => {
                    try {
                        const product = this.parseProductCard(card);
                        if (product) {
                            products.push(product);
                        }
                    } catch (error) {
                        console.error(`‚ùå Erro no card ${index}:`, error);
                    }
                });
            } catch (error) {
                console.error('‚ùå Erro no parser HTML:', error);
            }

            return products;
        }

        parseProductCard(card) {
            try {
                const image = card.querySelector('img');
                const info = card.querySelector('.info');
                const button = card.querySelector('.open-modal-btn');

                if (!image || !info || !button) {
                    return null;
                }

                const nome = button.getAttribute('data-name') || '';
                const id = button.getAttribute('data-id') || '';
                const descricao = button.getAttribute('data-specs') || '';
                const imageUrl = button.getAttribute('data-image') || image.src;
                
                // Extrai pre√ßo
                const precoElement = Array.from(info.querySelectorAll('p')).find(p => p.textContent.includes('R$'));
                const precoMatch = precoElement ? precoElement.textContent.match(/R\$\s*(\d+[.,]\d+)/) : null;
                const preco = precoMatch ? parseFloat(precoMatch[1].replace(',', '.')) : 0;

                const categoria = card.getAttribute('data-categoria') || 'personalizada';

                // Extrai op√ß√µes
                let opcoes = [];
                try {
                    const optionsJSON = button.getAttribute('data-options');
                    if (optionsJSON) {
                        opcoes = JSON.parse(optionsJSON.replace(/&#39;/g, "'"));
                    }
                } catch (e) {
                    console.warn('Erro ao parsear op√ß√µes:', e);
                }

                return {
                    id,
                    nome,
                    categoria,
                    preco,
                    descricao,
                    imageUrl,
                    opcoes,
                    htmlOriginal: card.outerHTML
                };

            } catch (error) {
                console.error('‚ùå Erro ao parsear card:', error);
                return null;
            }
        }

        exibirProdutos(products) {
            const container = document.getElementById('productsList');
            
            if (products.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>üì¶ Nenhum produto encontrado</h3>
                        <p>N√£o foram encontrados produtos no GitHub.</p>
                        <button class="action-btn" onclick="window.location.href='adicionar-produto.html'" style="margin-top: 1rem;">
                            ‚ûï Adicionar Primeiro Produto
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="products-grid">
                    ${products.map(product => `
                        <div class="product-card">
                            <div class="product-image">
                                <img src="${product.imageUrl}" alt="${product.nome}" 
                                     onerror="this.src='https://via.placeholder.com/300x200/1a1a1a/666666?text=Imagem'">
                            </div>
                            <div class="product-content">
                                <div class="product-header">
                                    <div>
                                        <h3 class="product-title">${product.nome}</h3>
                                        <div class="product-tags">
                                            <span class="product-tag">ID: ${product.id}</span>
                                            <span class="product-tag product-category">${product.categoria}</span>
                                            <span class="product-tag">${product.opcoes?.length || 0} modelos</span>
                                        </div>
                                    </div>
                                    <div class="product-price">R$ ${parseFloat(product.preco).toFixed(2)}</div>
                                </div>
                                
                                <p class="product-description">${product.descricao || 'Sem descri√ß√£o'}</p>
                                
                                <div class="product-actions">
                                    <button class="action-button edit" onclick="editarProduto('${product.id}')">‚úèÔ∏è Editar</button>
                                    <button class="action-button delete" onclick="excluirProduto('${product.id}')">üóëÔ∏è Excluir</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        loadStats() {
            document.getElementById('totalProducts').textContent = this.products.length;
            const categories = [...new Set(this.products.map(p => p.categoria))];
            document.getElementById('totalCategories').textContent = categories.length;
        }

        getProductById(productId) {
            return this.products.find(product => product.id === productId);
        }

        mostrarErro(mensagem) {
            const container = document.getElementById('productsList');
            container.innerHTML = `
                <div class="empty-state">
                    <h3>‚ùå Erro ao carregar</h3>
                    <p>${mensagem}</p>
                    <button class="action-btn" onclick="dashboard.carregarProdutosDoGitHub()" style="margin-top: 1rem;">
                        üîÑ Tentar Novamente
                    </button>
                </div>
            `;
        }
    }

    // INICIALIZA√á√ÉO
    const dashboard = new GitHubDashboard();

    // üî• FUN√á√ïES DE EDI√á√ÉO E EXCLUS√ÉO REAIS
    async function editarProduto(productId) {
        console.log('‚úèÔ∏è Editando produto:', productId);
        
        const product = dashboard.getProductById(productId);
        if (!product) {
            alert('‚ùå Produto n√£o encontrado!');
            return;
        }

        // Cria modal de edi√ß√£o
        const modalHTML = `
            <div class="modal-overlay" id="editModal" style="display: flex;">
                <div class="modal-content">
                    <h2 class="modal-title">‚úèÔ∏è Editar Produto</h2>
                    
                    <form id="editProductForm">
                        <div class="form-group">
                            <label class="form-label">Nome do Produto</label>
                            <input type="text" class="form-input" id="editProductName" value="${product.nome}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ID do Produto</label>
                            <input type="text" class="form-input" id="editProductId" value="${product.id}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Categoria</label>
                            <input type="text" class="form-input" id="editProductCategory" value="${product.categoria}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Pre√ßo (R$)</label>
                            <input type="number" class="form-input" id="editProductPrice" step="0.01" value="${product.preco}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Descri√ß√£o</label>
                            <textarea class="form-textarea" id="editProductDescription" rows="3">${product.descricao || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">URL da Imagem</label>
                            <input type="url" class="form-input" id="editProductImage" value="${product.imageUrl}">
                        </div>
                        
                        <div class="form-buttons">
                            <button type="button" class="btn btn-cancel" onclick="fecharModal()">Cancelar</button>
                            <button type="submit" class="btn btn-primary">üíæ Salvar no GitHub</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Configura o formul√°rio
        document.getElementById('editProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await salvarEdicao(product);
        });

        dashboard.currentEditingProduct = product;
    }

    async function salvarEdicao(product) {
        const nome = document.getElementById('editProductName').value.trim();
        const id = document.getElementById('editProductId').value.trim();
        const categoria = document.getElementById('editProductCategory').value.trim();
        const preco = parseFloat(document.getElementById('editProductPrice').value);
        const descricao = document.getElementById('editProductDescription').value.trim();
        const imageUrl = document.getElementById('editProductImage').value.trim();

        if (!nome || !id || !categoria || isNaN(preco)) {
            alert('‚ùå Preencha todos os campos obrigat√≥rios!');
            return;
        }

        try {
            // Mostra loading
            document.querySelector('.btn-primary').textContent = '‚è≥ Salvando...';
            document.querySelector('.btn-primary').disabled = true;

            // Gera novo HTML
            const novoHTML = gerarHTMLProduto({
                nome,
                id,
                categoria,
                preco,
                descricao,
                imageUrl,
                opcoes: product.opcoes || [{ model: "Padr√£o", price: preco, image: imageUrl }]
            });

            console.log('üìù Enviando para GitHub...');
            
            // Envia para API
            const response = await fetch('/api/github-update-product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    oldHtml: product.htmlOriginal,
                    newHtml: novoHTML,
                    commitMessage: `‚úèÔ∏è Editar produto: ${nome} (ID: ${id})`
                })
            });

            const data = await response.json();

            if (data.success) {
                alert('‚úÖ Produto atualizado no GitHub!\n\nO site ser√° atualizado em 1-2 minutos.');
                fecharModal();
                
                // Recarrega os produtos
                setTimeout(() => {
                    dashboard.carregarProdutosDoGitHub();
                }, 2000);
                
            } else {
                throw new Error(data.error || 'Erro desconhecido');
            }

        } catch (error) {
            console.error('‚ùå Erro ao salvar:', error);
            alert('‚ùå Erro ao atualizar: ' + error.message);
        } finally {
            // Restaura bot√£o
            const btn = document.querySelector('.btn-primary');
            if (btn) {
                btn.textContent = 'üíæ Salvar no GitHub';
                btn.disabled = false;
            }
        }
    }

    async function excluirProduto(productId) {
        console.log('üóëÔ∏è Excluindo produto:', productId);
        
        const product = dashboard.getProductById(productId);
        if (!product) {
            alert('‚ùå Produto n√£o encontrado!');
            return;
        }

        if (confirm(`‚ö†Ô∏è TEM CERTEZA que deseja excluir?\n\n"${product.nome}" (ID: ${product.id})\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
            try {
                // Mostra loading
                const buttons = document.querySelectorAll(`button[onclick="excluirProduto('${productId}')"]`);
                buttons.forEach(btn => {
                    btn.textContent = '‚è≥ Excluindo...';
                    btn.disabled = true;
                });

                console.log('üóëÔ∏è Enviando exclus√£o para GitHub...');
                
                const response = await fetch('/api/github-delete-product', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        productHtml: product.htmlOriginal,
                        commitMessage: `üóëÔ∏è Excluir produto: ${product.nome} (ID: ${product.id})`
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Produto exclu√≠do do GitHub!\n\nO site ser√° atualizado em 1-2 minutos.');
                    
                    // Recarrega os produtos
                    setTimeout(() => {
                        dashboard.carregarProdutosDoGitHub();
                    }, 2000);
                    
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }

            } catch (error) {
                console.error('‚ùå Erro ao excluir:', error);
                alert('‚ùå Erro ao excluir: ' + error.message);
                
                // Restaura bot√µes
                const buttons = document.querySelectorAll(`button[onclick="excluirProduto('${productId}')"]`);
                buttons.forEach(btn => {
                    btn.textContent = 'üóëÔ∏è Excluir';
                    btn.disabled = false;
                });
            }
        }
    }

    function gerarHTMLProduto(product) {
        const opcoesJSON = JSON.stringify(product.opcoes).replace(/'/g, "&#39;");

        return `
<div class="item" data-categoria="${product.categoria}">
    <img src="${product.imageUrl}" alt="${product.nome}" loading="lazy">
    <div class="info">
        <h2>${product.nome}</h2>
        <p>ID: ${product.id}</p>
        <p>R$ ${product.preco.toFixed(2)}</p>
        <button class="open-modal-btn"
            data-name="${product.nome}"
            data-id="${product.id}"
            data-image="${product.imageUrl}"
            data-specs="${product.descricao}"
            data-options='${opcoesJSON}'>
            Ver Detalhes
        </button>
    </div>
</div>`.trim();
    }

    function fecharModal() {
        const modal = document.getElementById('editModal');
        if (modal) modal.remove();
    }

    function carregarProdutos() {
        dashboard.carregarProdutosDoGitHub();
    }

    function verEstatisticas() {
        const products = dashboard.products;
        const categorias = [...new Set(products.map(p => p.categoria))];
        const precoMedio = products.length > 0 ? 
            products.reduce((acc, p) => acc + p.preco, 0) / products.length : 0;
        
        alert(`üìä Estat√≠sticas do Site:\n\n‚Ä¢ Total de Produtos: ${products.length}\n‚Ä¢ Categorias: ${categorias.length}\n‚Ä¢ Pre√ßo M√©dio: R$ ${precoMedio.toFixed(2)}`);
    }

    function logout() {
        localStorage.removeItem('admin_token_canecas');
        window.location.href = 'login.html';
    }

    // Fechar modal com ESC ou clique fora
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') fecharModal();
    });

    document.addEventListener('click', (e) => {
        if (e.target.id === 'editModal') fecharModal();
    });

    // INICIALIZA√á√ÉO
    document.addEventListener('DOMContentLoaded', () => {
        dashboard.init();
    });
</script>
