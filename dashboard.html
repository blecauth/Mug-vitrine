<script>
    // üî• DASHBOARD CONECTADO AO GITHUB - CORRIGIDO
    class GitHubDashboard {
        constructor() {
            this.products = [];
            this.currentDisplayedProducts = []; // üî• NOVO: produtos atualmente exibidos
            this.init();
        }

        async init() {
            this.mostrarLoading(true, 'üîÑ Conectando com GitHub...');
            await this.carregarProdutosDoGitHub();
            this.loadStats();
            this.setupSearch();
            this.mostrarLoading(false, '‚úÖ Conectado com GitHub');
        }

        async carregarProdutosDoGitHub() {
            try {
                console.log('üì° Buscando produtos do GitHub...');
                
                // Busca o conte√∫do do index.html do GitHub
                const response = await fetch('/api/github-read');
                const data = await response.json();

                if (data.success && data.content) {
                    console.log('‚úÖ Conte√∫do do GitHub recebido');
                    this.products = this.extrairProdutosDoHTML(data.content);
                    this.currentDisplayedProducts = [...this.products]; // üî• INICIALIZA
                    this.exibirProdutos(this.currentDisplayedProducts);
                } else {
                    throw new Error(data.error || 'Erro ao carregar do GitHub');
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar do GitHub:', error);
                this.mostrarErro('Erro ao carregar produtos: ' + error.message);
            }
        }

        extrairProdutosDoHTML(htmlContent) {
            const products = [];
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            
            // Encontra todos os cards de produtos
            const productCards = doc.querySelectorAll('.item');
            
            console.log(`üì¶ Encontrados ${productCards.length} produtos no HTML`);

            productCards.forEach((card, index) => {
                try {
                    const product = this.parseProductCard(card);
                    if (product) {
                        // üî• ADICIONA ID √öNICO para refer√™ncia segura
                        product.uniqueId = `prod_${Date.now()}_${index}`;
                        products.push(product);
                    }
                } catch (error) {
                    console.error(`‚ùå Erro ao parsear card ${index}:`, error);
                }
            });

            return products;
        }

        parseProductCard(card) {
            // Extrai informa√ß√µes do card
            const image = card.querySelector('img');
            const info = card.querySelector('.info');
            const button = card.querySelector('.open-modal-btn');

            if (!image || !info || !button) {
                console.warn('Card incompleto:', card);
                return null;
            }

            const nomeElement = info.querySelector('h2');
            const idElement = info.querySelector('p');
            const precoElement = Array.from(info.querySelectorAll('p')).find(p => p.textContent.includes('R$'));

            if (!nomeElement || !idElement || !precoElement) {
                console.warn('Card sem informa√ß√µes b√°sicas:', card);
                return null;
            }

            // Extrai dados do bot√£o modal
            const nome = button.getAttribute('data-name') || nomeElement.textContent;
            const id = button.getAttribute('data-id') || idElement.textContent.replace('ID: ', '');
            const imageUrl = button.getAttribute('data-image') || image.src;
            const descricao = button.getAttribute('data-specs') || '';
            
            // Extrai pre√ßo
            const precoMatch = precoElement.textContent.match(/R\$\s*(\d+[.,]\d+)/);
            const preco = precoMatch ? parseFloat(precoMatch[1].replace(',', '.')) : 0;

            // Extrai categoria do data-categoria
            const categoria = card.getAttribute('data-categoria') || 'personalizada';

            // Extrai op√ß√µes do modal
            let opcoes = [];
            try {
                const optionsJSON = button.getAttribute('data-options');
                if (optionsJSON) {
                    opcoes = JSON.parse(optionsJSON.replace(/&#39;/g, "'"));
                }
            } catch (e) {
                console.warn('Erro ao parsear op√ß√µes:', e);
            }

            return {
                id,
                nome,
                categoria,
                preco,
                descricao,
                imageUrl,
                opcoes,
                htmlOriginal: card.outerHTML
            };
        }

        exibirProdutos(products) {
            const container = document.getElementById('productsList');
            
            // üî• ATUALIZA lista atual de exibi√ß√£o
            this.currentDisplayedProducts = products;
            
            if (products.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>üì¶ Nenhum produto encontrado</h3>
                        <p>Nenhum produto foi encontrado no seu site GitHub</p>
                        <button class="action-btn" onclick="window.location.href='adicionar-produto.html'" style="margin-top: 1rem;">
                            ‚ûï Adicionar Primeiro Produto
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="products-grid">
                    ${products.map((product, index) => `
                        <div class="product-card">
                            <div class="product-image">
                                <img src="${product.imageUrl}" alt="${product.nome}" 
                                     onerror="this.src='https://via.placeholder.com/300x200/1a1a1a/666666?text=Imagem'">
                            </div>
                            <div class="product-content">
                                <div class="product-header">
                                    <div>
                                        <h3 class="product-title">${product.nome}</h3>
                                        <div class="product-tags">
                                            <span class="product-tag">ID: ${product.id}</span>
                                            <span class="product-tag product-category">${product.categoria}</span>
                                            <span class="product-tag">${product.opcoes?.length || 0} modelos</span>
                                        </div>
                                    </div>
                                    <div class="product-price">R$ ${parseFloat(product.preco).toFixed(2)}</div>
                                </div>
                                
                                <p class="product-description">${product.descricao || 'Sem descri√ß√£o'}</p>
                                
                                <div class="product-actions">
                                    <button class="action-button edit" onclick="editarProdutoGitHub('${product.id}')">‚úèÔ∏è Editar</button>
                                    <button class="action-button delete" onclick="excluirProdutoGitHub('${product.id}')">üóëÔ∏è Excluir</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        loadStats() {
            document.getElementById('totalProducts').textContent = this.products.length;
            
            const categories = [...new Set(this.products.map(p => p.categoria))];
            document.getElementById('totalCategories').textContent = categories.length;
        }

        setupSearch() {
            const searchInput = document.getElementById('searchProducts');
            searchInput.addEventListener('input', (e) => {
                this.filtrarProdutos(e.target.value);
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.filtrarProdutos(e.target.value);
                }
            });
        }

        filtrarProdutos(termo = null) {
            const searchTerm = termo || document.getElementById('searchProducts').value.toLowerCase();
            
            if (!searchTerm) {
                this.exibirProdutos(this.products);
                return;
            }

            const filteredProducts = this.products.filter(product => 
                product.nome.toLowerCase().includes(searchTerm) ||
                product.id.toLowerCase().includes(searchTerm) ||
                product.descricao.toLowerCase().includes(searchTerm) ||
                product.categoria.toLowerCase().includes(searchTerm)
            );

            this.exibirProdutos(filteredProducts);
        }

        // üî• CORRE√á√ÉO: Busca produto por ID (n√£o por √≠ndice)
        getProductById(productId) {
            return this.products.find(product => product.id === productId);
        }

        // üî• CORRE√á√ÉO: Busca produto atual por ID
        getCurrentProductById(productId) {
            return this.currentDisplayedProducts.find(product => product.id === productId);
        }

        mostrarLoading(mostrar, mensagem = '') {
            const spinner = document.getElementById('syncSpinner');
            const message = document.getElementById('syncMessage');
            const status = document.getElementById('syncStatus');

            if (mostrar) {
                spinner.style.display = 'inline-block';
                status.style.display = 'flex';
            } else {
                spinner.style.display = 'none';
                if (!mensagem) {
                    status.style.display = 'none';
                }
            }

            if (mensagem) {
                message.textContent = mensagem;
            }
        }

        mostrarErro(mensagem) {
            this.mostrarLoading(false, `‚ùå ${mensagem}`);
            
            const container = document.getElementById('productsList');
            container.innerHTML = `
                <div class="empty-state">
                    <h3>‚ùå Erro ao carregar</h3>
                    <p>${mensagem}</p>
                    <button class="action-btn" onclick="dashboard.carregarProdutosDoGitHub()" style="margin-top: 1rem;">
                        üîÑ Tentar Novamente
                    </button>
                </div>
            `;
        }
    }

    // üî• INICIALIZA DASHBOARD
    const dashboard = new GitHubDashboard();

    // üî• FUN√á√ïES DE GERENCIAMENTO GITHUB - CORRIGIDAS
    async function editarProdutoGitHub(productId) {
        console.log('‚úèÔ∏è Editando produto ID:', productId);
        
        const product = dashboard.getProductById(productId);
        if (!product) {
            alert('‚ùå Produto n√£o encontrado! ID: ' + productId);
            return;
        }

        const modalHTML = `
            <div class="modal-overlay" id="editModal">
                <div class="modal-content">
                    <h2 class="modal-title">‚úèÔ∏è Editar Produto no GitHub</h2>
                    
                    <form id="editProductForm">
                        <div class="form-group">
                            <label class="form-label">Nome do Produto</label>
                            <input type="text" class="form-input" id="editProductName" value="${this.escapeHtml(product.nome)}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ID do Produto</label>
                            <input type="text" class="form-input" id="editProductId" value="${this.escapeHtml(product.id)}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Categoria</label>
                            <input type="text" class="form-input" id="editProductCategory" value="${this.escapeHtml(product.categoria)}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Pre√ßo (R$)</label>
                            <input type="number" class="form-input" id="editProductPrice" step="0.01" value="${product.preco}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Descri√ß√£o</label>
                            <textarea class="form-textarea" id="editProductDescription" rows="3">${this.escapeHtml(product.descricao || '')}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">URL da Imagem</label>
                            <input type="url" class="form-input" id="editProductImage" value="${this.escapeHtml(product.imageUrl)}">
                            <small style="color: #888;">Cole aqui a URL da nova imagem</small>
                        </div>
                        
                        <div class="form-buttons">
                            <button type="button" class="btn btn-cancel" onclick="fecharModalEdicao()">Cancelar</button>
                            <button type="submit" class="btn btn-primary">üíæ Atualizar no GitHub</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        const form = document.getElementById('editProductForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await salvarEdicaoGitHub(productId);
        });
    }

    async function salvarEdicaoGitHub(productId) {
        console.log('üíæ Salvando edi√ß√£o do produto ID:', productId);
        
        const product = dashboard.getProductById(productId);
        if (!product) {
            alert('‚ùå Produto n√£o encontrado durante a edi√ß√£o!');
            return;
        }

        const nome = document.getElementById('editProductName').value.trim();
        const id = document.getElementById('editProductId').value.trim();
        const categoria = document.getElementById('editProductCategory').value.trim();
        const preco = parseFloat(document.getElementById('editProductPrice').value);
        const descricao = document.getElementById('editProductDescription').value.trim();
        const imageUrl = document.getElementById('editProductImage').value.trim();

        if (!nome || !id || !categoria || isNaN(preco)) {
            alert('‚ùå Preencha todos os campos obrigat√≥rios!');
            return;
        }

        try {
            dashboard.mostrarLoading(true, 'üîÑ Atualizando no GitHub...');

            // Gera o novo HTML do produto
            const novoHTML = gerarHTMLProduto({
                nome,
                id,
                categoria,
                preco,
                descricao,
                imageUrl,
                opcoes: product.opcoes || [{ model: "Padr√£o", price: preco, image: imageUrl }]
            });

            console.log('üìù Enviando atualiza√ß√£o para GitHub...');
            console.log('HTML Antigo:', product.htmlOriginal.substring(0, 100) + '...');
            console.log('HTML Novo:', novoHTML.substring(0, 100) + '...');

            // Atualiza no GitHub
            const response = await fetch('/api/github-update-product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    oldHtml: product.htmlOriginal,
                    newHtml: novoHTML,
                    commitMessage: `‚úèÔ∏è Editar produto: ${nome} (ID: ${id})`
                })
            });

            const data = await response.json();
            console.log('üì® Resposta da API:', data);

            if (data.success) {
                fecharModalEdicao();
                alert('‚úÖ Produto atualizado no GitHub!\n\nO site ser√° atualizado em 1-2 minutos.');
                
                // Recarrega os produtos ap√≥s um tempo
                setTimeout(() => {
                    dashboard.carregarProdutosDoGitHub();
                }, 3000);
                
            } else {
                throw new Error(data.error || 'Erro ao atualizar no GitHub');
            }

        } catch (error) {
            console.error('‚ùå Erro ao atualizar:', error);
            alert('‚ùå Erro ao atualizar produto: ' + error.message);
        } finally {
            dashboard.mostrarLoading(false);
        }
    }

    async function excluirProdutoGitHub(productId) {
        console.log('üóëÔ∏è Excluindo produto ID:', productId);
        
        const product = dashboard.getProductById(productId);
        if (!product) {
            alert('‚ùå Produto n√£o encontrado! ID: ' + productId);
            return;
        }

        if (confirm(`‚ö†Ô∏è Tem certeza que deseja excluir o produto do site?\n\n"${product.nome}" (ID: ${product.id})\n\nEsta a√ß√£o remover√° o produto permanentemente do GitHub!`)) {
            try {
                dashboard.mostrarLoading(true, 'üóëÔ∏è Excluindo do GitHub...');

                console.log('üìù Enviando exclus√£o para GitHub...');
                console.log('HTML a excluir:', product.htmlOriginal.substring(0, 100) + '...');

                const response = await fetch('/api/github-delete-product', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        productHtml: product.htmlOriginal,
                        commitMessage: `üóëÔ∏è Excluir produto: ${product.nome} (ID: ${product.id})`
                    })
                });

                const data = await response.json();
                console.log('üì® Resposta da API Exclus√£o:', data);

                if (data.success) {
                    alert('‚úÖ Produto exclu√≠do do GitHub!\n\nO site ser√° atualizado em 1-2 minutos.');
                    
                    // Recarrega os produtos ap√≥s um tempo
                    setTimeout(() => {
                        dashboard.carregarProdutosDoGitHub();
                    }, 3000);
                    
                } else {
                    throw new Error(data.error || 'Erro ao excluir no GitHub');
                }

            } catch (error) {
                console.error('‚ùå Erro ao excluir:', error);
                alert('‚ùå Erro ao excluir produto: ' + error.message);
            } finally {
                dashboard.mostrarLoading(false);
            }
        }
    }

    function gerarHTMLProduto(product) {
        const opcoesJSON = JSON.stringify(product.opcoes).replace(/'/g, "&#39;");

        return `
<div class="item" data-categoria="${this.escapeHtml(product.categoria)}">
    <img src="${this.escapeHtml(product.imageUrl)}" alt="${this.escapeHtml(product.nome)}" loading="lazy">
    <div class="info">
        <h2>${this.escapeHtml(product.nome)}</h2>
        <p>ID: ${this.escapeHtml(product.id)}</p>
        <p>R$ ${product.preco.toFixed(2)}</p>
        <button class="open-modal-btn"
            data-name="${this.escapeHtml(product.nome)}"
            data-id="${this.escapeHtml(product.id)}"
            data-image="${this.escapeHtml(product.imageUrl)}"
            data-specs="${this.escapeHtml(product.descricao)}"
            data-options='${opcoesJSON}'>
            Ver Detalhes
        </button>
    </div>
</div>`.trim();
    }

    // üî• FUN√á√ÉO AUXILIAR: Escape HTML para prevenir XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function fecharModalEdicao() {
        const modal = document.getElementById('editModal');
        if (modal) modal.remove();
    }

    function filtrarProdutos() {
        dashboard.filtrarProdutos();
    }

    async function sincronizarComGitHub() {
        await dashboard.carregarProdutosDoGitHub();
    }

    // Fun√ß√µes globais
    function verEstatisticas() {
        const products = dashboard.products;
        const categorias = [...new Set(products.map(p => p.categoria))];
        const precoMedio = products.length > 0 ? products.reduce((acc, p) => acc + p.preco, 0) / products.length : 0;
        
        alert(`üìä Estat√≠sticas do Site:\n\n‚Ä¢ Total de Produtos: ${products.length}\n‚Ä¢ Categorias: ${categorias.length}\n‚Ä¢ Pre√ßo M√©dio: R$ ${precoMedio.toFixed(2)}\n\nCategorias:\n${categorias.map(cat => `  - ${cat}`).join('\n')}`);
    }

    function backupDados() {
        const data = JSON.stringify(dashboard.products, null, 2);
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_produtos_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        alert('üíæ Backup realizado com sucesso!');
    }

    function logout() {
        localStorage.removeItem('admin_token_canecas');
        window.location.href = 'login.html';
    }

    // Fechar modal com ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            fecharModalEdicao();
        }
    });

    // üî• EXPORTA fun√ß√µes para escopo global
    window.editarProdutoGitHub = editarProdutoGitHub;
    window.excluirProdutoGitHub = excluirProdutoGitHub;
    window.escapeHtml = escapeHtml;
</script>
