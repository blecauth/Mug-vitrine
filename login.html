// /src/dashboard.js - VERS√ÉO CORRIGIDA E FUNCIONAL
class Dashboard {
    constructor() {
        this.productsKey = 'canecas_products';
        this.categoriesKey = 'canecas_categories';
        this.init();
    }

    init() {
        this.loadStats();
        this.loadAllProducts(); // üîÑ M√©todo corrigido
        this.setupCategories();
        this.setupEventListeners();
    }

    // üîÑ CARREGA TODOS OS PRODUTOS (CORRIGIDO)
    loadAllProducts() {
        console.log('üîÑ Carregando todos os produtos...');
        
        // 1. Primeiro carrega do localStorage
        const storedProducts = this.getProducts();
        console.log('üì¶ Produtos no localStorage:', storedProducts.length);
        
        // 2. Adiciona produtos padr√£o do site se n√£o existirem
        const defaultProducts = this.getDefaultProducts();
        const allProducts = this.mergeProducts(storedProducts, defaultProducts);
        
        // 3. Salva se houve mudan√ßas
        if (allProducts.length > storedProducts.length) {
            console.log('üíæ Salvando produtos combinados...');
            this.saveProducts(allProducts);
        }
        
        // 4. Exibe todos os produtos
        this.displayAllProducts(allProducts);
    }

    // üéØ PRODUTOS PADR√ÉO DO SEU SITE
    getDefaultProducts() {
        return [
            {
                id: "0001",
                nome: "Caneca teste",
                categoria: "floral",
                preco: 32.00,
                descricao: "Caneca de teste com design floral",
                imageUrl: "https://i.ibb.co/7x7ZbVKQ/IMG-20251022-WA0007.jpg",
                specs: "Gege",
                options: [
                    {"model": "Branca", "price": 32.00, "image": "https://i.ibb.co/7x7ZbVKQ/IMG-20251022-WA0007.jpg"},
                    {"model": "Preta", "price": 25.00, "image": "https://i.ibb.co/0jVBTx2H/IMG-20251021-WA0001.jpg"}
                ],
                dataCriacao: new Date().toISOString(),
                origem: "site"
            },
            {
                id: "Cn0001",
                nome: "Caneca teste",
                categoria: "floral",
                preco: 40.00,
                descricao: "Caneca teste preta",
                imageUrl: "https://i.ibb.co/0jVBTx2H/IMG-20251021-WA0001.jpg",
                specs: "Nznxn",
                options: [
                    {"model": "Branca", "price": 40.00, "image": "https://i.ibb.co/0jVBTx2H/IMG-20251021-WA0001.jpg"},
                    {"model": "Preta", "price": 42.00, "image": "https://i.ibb.co/N6c4DxfJ/IMG-20251021-WA0000.jpg"}
                ],
                dataCriacao: new Date().toISOString(),
                origem: "site"
            },
            {
                id: "CN0001",
                nome: "Caneca Orgulho Negro",
                categoria: "personalizada",
                preco: 30.00,
                descricao: "Caneca de cer√¢mica com estampa exclusiva",
                imageUrl: "https://i.ibb.co/0jVBTx2H/IMG-20251021-WA0001.jpg",
                specs: "Caneca de cer√¢mica com estampa exclusiva.",
                options: [
                    {"model": "Branca", "price": 30.00, "image": "https://i.ibb.co/0jVBTx2H/IMG-20251021-WA0001.jpg"},
                    {"model": "Preta", "price": 32.00, "image": "https://i.ibb.co/PjX9108/IMG-20251021-WA0002.jpg"}
                ],
                dataCriacao: new Date().toISOString(),
                origem: "site"
            }
        ];
    }

    // üîÑ COMBINA PRODUTOS (evita duplicatas por ID)
    mergeProducts(storedProducts, defaultProducts) {
        const merged = [...storedProducts];
        
        defaultProducts.forEach(defaultProduct => {
            const exists = merged.find(p => p.id === defaultProduct.id);
            if (!exists) {
                merged.push(defaultProduct);
            }
        });
        
        console.log('üîÑ Produtos combinados:', merged.length);
        return merged;
    }

    // üéØ EXIBE TODOS OS PRODUTOS NO DASHBOARD
    displayAllProducts(products) {
        const productsList = document.getElementById('productsList');
        console.log('üé¥ Exibindo produtos:', products.length);
        
        if (products.length === 0) {
            productsList.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #888;">
                    <p>üì¶ Nenhum produto cadastrado</p>
                    <button onclick="showAddProductModal()" class="action-btn" style="margin-top: 1rem;">
                        ‚ûï Adicionar Primeiro Produto
                    </button>
                </div>
            `;
            return;
        }

        productsList.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                <h3>üì¶ Todos os Produtos (${products.length})</h3>
                <div style="display: flex; gap: 1rem;">
                    <button onclick="showAddProductModal()" class="action-btn" style="background: #25D366;">
                        ‚ûï Novo Produto
                    </button>
                    <button onclick="exportAllProducts()" class="action-btn" style="background: #007bff;">
                        üì§ Exportar Tudo
                    </button>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
                ${products.map(product => this.createProductCard(product)).join('')}
            </div>
        `;
    }

    // üé¥ CRIA CARD COMPLETO DO PRODUTO
    createProductCard(product) {
        const options = product.options || [
            { model: "Branca", price: product.preco, image: product.imageUrl }
        ];
        
        const specs = product.specs || product.descricao || "Caneca de cer√¢mica de alta qualidade";
        
        return `
            <div class="product-card" style="background: #1a1a1a; border: 1px solid #333; border-radius: 12px; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease;">
                <!-- IMAGEM -->
                <div style="position: relative; height: 200px; overflow: hidden;">
                    <img src="${product.imageUrl}" 
                         alt="${product.nome}"
                         style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease;"
                         onerror="this.src='https://via.placeholder.com/300x200/1a1a1a/666666?text=Imagem+N√£o+Encontrada'">
                    <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 0.3rem 0.6rem; border-radius: 20px; font-size: 0.8rem;">
                        ${product.origem === 'site' ? 'üåê Site' : 'üíæ Local'}
                    </div>
                </div>
                
                <!-- INFORMA√á√ïES -->
                <div style="padding: 1.5rem;">
                    <!-- CABE√áALHO -->
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div>
                            <h3 style="color: #25D366; margin: 0 0 0.3rem 0; font-size: 1.2rem;">${product.nome}</h3>
                            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                <span style="background: #333; color: #ccc; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem;">
                                    ID: ${product.id}
                                </span>
                                <span style="background: #25D366; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem;">
                                    ${product.categoria}
                                </span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.5rem; color: #25D366; font-weight: bold;">
                                R$ ${parseFloat(product.preco).toFixed(2)}
                            </div>
                            <div style="font-size: 0.8rem; color: #888;">
                                ${product.views || 0} visualiza√ß√µes
                            </div>
                        </div>
                    </div>
                    
                    <!-- DESCRI√á√ÉO -->
                    <div style="margin-bottom: 1rem;">
                        <p style="color: #ccc; margin: 0; font-size: 0.9rem; line-height: 1.4;">
                            ${product.descricao || specs}
                        </p>
                    </div>
                    
                    <!-- MODELOS DISPON√çVEIS -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: #fff; margin: 0 0 0.5rem 0; font-size: 0.9rem;">Modelos:</h4>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${options.map(opt => `
                                <span style="background: #333; color: #ccc; padding: 0.3rem 0.6rem; border-radius: 8px; font-size: 0.8rem;">
                                    ${opt.model} - R$ ${parseFloat(opt.price).toFixed(2)}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- BOT√ïES DE A√á√ÉO -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button onclick="editProduct('${product.id}')" 
                                style="background: #25D366; color: white; border: none; padding: 0.6rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                            ‚úèÔ∏è Editar
                        </button>
                        <button onclick="viewProductDetails('${product.id}')" 
                                style="background: #007bff; color: white; border: none; padding: 0.6rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                            üëÅÔ∏è Detalhes
                        </button>
                        <button onclick="previewOnSite('${product.id}')" 
                                style="background: #6f42c1; color: white; border: none; padding: 0.6rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                            üåê Preview
                        </button>
                        <button onclick="deleteProduct('${product.id}')" 
                                style="background: #ff4444; color: white; border: none; padding: 0.6rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                            üóëÔ∏è Excluir
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // üìä CARREGA ESTAT√çSTICAS
    loadStats() {
        const products = this.getProducts();
        const categories = new Set(products.map(p => p.categoria));
        const totalValue = products.reduce((sum, p) => sum + (parseFloat(p.preco) || 0), 0);
        
        document.getElementById('totalProducts').textContent = products.length;
        document.getElementById('totalCategories').textContent = categories.size;
    }

    // ‚öôÔ∏è CONFIGURA CATEGORIAS
    setupCategories() {
        const defaultCategories = [
            'Brancas', 'Coloridas', 'Dia das M√£es', 'Dia dos Pais',
            'Dia dos Professores', 'Pets', 'Her√≥is', 'Animes',
            'Com Foto', 'Futebol', 'Personalizadas', 'Promocionais'
        ];
        
        const currentCategories = this.getCategories();
        if (currentCategories.length === 0) {
            localStorage.setItem(this.categoriesKey, JSON.stringify(defaultCategories));
        }
    }

    // üéØ EVENT LISTENERS
    setupEventListeners() {
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                this.loadStats();
            }
        });
    }

    // üíæ GETTERS E SETTERS
    getProducts() {
        try {
            return JSON.parse(localStorage.getItem(this.productsKey)) || [];
        } catch {
            return [];
        }
    }

    getCategories() {
        try {
            return JSON.parse(localStorage.getItem(this.categoriesKey)) || [];
        } catch {
            return [];
        }
    }

    saveProducts(products) {
        localStorage.setItem(this.productsKey, JSON.stringify(products));
        this.loadStats();
        this.loadAllProducts(); // Recarrega a lista
    }
}

// üéØ INICIALIZA DASHBOARD
const dashboard = new Dashboard();

// üîß FUN√á√ïES GLOBAIS
function showAddProductModal(product = null) {
    const isEdit = !!product;
    const modalHTML = `
        <div id="productModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 2000;">
            <div style="background: #1a1a1a; padding: 2rem; border-radius: 10px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
                <h2 style="color: #25D366;">${isEdit ? '‚úèÔ∏è Editar' : '‚ûï Adicionar'} Produto</h2>
                
                <form id="productForm" onsubmit="handleProductSubmit(event, ${isEdit ? `'${product?.id}'` : 'null'})">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #ccc;">Nome do Produto</label>
                        <input type="text" id="productName" value="${product?.nome || ''}" required 
                               style="width: 100%; padding: 0.8rem; border-radius: 5px; border: 1px solid #333; background: #2a2a2a; color: white;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #ccc;">ID do Produto</label>
                        <input type="text" id="productId" value="${product?.id || ''}" ${isEdit ? 'readonly' : ''} required
                               style="width: 100%; padding: 0.8rem; border-radius: 5px; border: 1px solid #333; background: #2a2a2a; color: white;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #ccc;">Categoria</label>
                        <select id="productCategory" required
                                style="width: 100%; padding: 0.8rem; border-radius: 5px; border: 1px solid #333; background: #2a2a2a; color: white;">
                            <option value="">Selecione uma categoria</option>
                            ${dashboard.getCategories().map(cat => 
                                `<option value="${cat}" ${product?.categoria === cat ? 'selected' : ''}>${cat}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #ccc;">Pre√ßo (R$)</label>
                        <input type="number" id="productPrice" step="0.01" value="${product?.preco || ''}" required
                               style="width: 100%; padding: 0.8rem; border-radius: 5px; border: 1px solid #333; background: #2a2a2a; color: white;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #ccc;">Descri√ß√£o</label>
                        <textarea id="productDescription" rows="3"
                                  style="width: 100%; padding: 0.8rem; border-radius: 5px; border: 1px solid #333; background: #2a2a2a; color: white;">${product?.descricao || ''}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #ccc;">URL da Imagem</label>
                        <input type="url" id="productImage" value="${product?.imageUrl || ''}" 
                               style="width: 100%; padding: 0.8rem; border-radius: 5px; border: 1px solid #333; background: #2a2a2a; color: white;">
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" onclick="closeProductModal()" 
                                style="padding: 0.8rem 1.5rem; border: 1px solid #666; background: transparent; color: #ccc; border-radius: 5px; cursor: pointer;">
                            Cancelar
                        </button>
                        <button type="submit"
                                style="padding: 0.8rem 1.5rem; background: #25D366; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ${isEdit ? 'üíæ Salvar' : '‚ûï Adicionar'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeProductModal() {
    const modal = document.getElementById('productModal');
    if (modal) modal.remove();
}

function handleProductSubmit(event, productId = null) {
    event.preventDefault();
    
    const productData = {
        nome: document.getElementById('productName').value,
        id: document.getElementById('productId').value,
        categoria: document.getElementById('productCategory').value,
        preco: parseFloat(document.getElementById('productPrice').value),
        descricao: document.getElementById('productDescription').value,
        imageUrl: document.getElementById('productImage').value,
        dataAtualizacao: new Date().toISOString(),
        origem: "local"
    };
    
    const products = dashboard.getProducts();
    
    if (productId) {
        // Editar produto existente
        const index = products.findIndex(p => p.id === productId);
        if (index !== -1) {
            products[index] = { ...products[index], ...productData };
        }
    } else {
        // Adicionar novo produto
        productData.dataCriacao = new Date().toISOString();
        productData.views = 0;
        products.push(productData);
    }
    
    dashboard.saveProducts(products);
    closeProductModal();
    alert(`‚úÖ Produto ${productId ? 'atualizado' : 'adicionado'} com sucesso!`);
}

function editProduct(productId) {
    const products = dashboard.getProducts();
    const product = products.find(p => p.id === productId);
    if (product) {
        showAddProductModal(product);
    }
}

function deleteProduct(productId) {
    if (confirm('‚ö†Ô∏è Tem certeza que deseja excluir este produto?\nEsta a√ß√£o n√£o pode ser desfeita.')) {
        const products = dashboard.getProducts();
        const updatedProducts = products.filter(p => p.id !== productId);
        dashboard.saveProducts(updatedProducts);
        alert('‚úÖ Produto exclu√≠do com sucesso!');
    }
}

function viewProductDetails(productId) {
    const products = dashboard.getProducts();
    const product = products.find(p => p.id === productId);
    
    if (product) {
        const detailsHTML = `
            <div style="background: #1a1a1a; padding: 2rem; border-radius: 10px; max-width: 600px; margin: 2rem auto;">
                <h2 style="color: #25D366; margin-bottom: 1rem;">üîç Detalhes do Produto</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div><strong>ID:</strong> ${product.id}</div>
                    <div><strong>Categoria:</strong> ${product.categoria}</div>
                    <div><strong>Nome:</strong> ${product.nome}</div>
                    <div><strong>Pre√ßo:</strong> R$ ${parseFloat(product.preco).toFixed(2)}</div>
                    <div><strong>Visualiza√ß√µes:</strong> ${product.views || 0}</div>
                    <div><strong>Origem:</strong> ${product.origem || 'local'}</div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <strong>Descri√ß√£o:</strong>
                    <p style="color: #ccc; margin-top: 0.5rem;">${product.descricao || 'Sem descri√ß√£o'}</p>
                </div>
                
                ${product.imageUrl ? `
                <div style="margin-bottom: 1.5rem;">
                    <strong>Imagem:</strong>
                    <img src="${product.imageUrl}" style="max-width: 200px; border-radius: 8px; margin-top: 0.5rem;">
                </div>
                ` : ''}
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeModal()" 
                            style="padding: 0.6rem 1.2rem; border: 1px solid #666; background: transparent; color: #ccc; border-radius: 5px; cursor: pointer;">
                        Fechar
                    </button>
                    <button onclick="editProduct('${product.id}')" 
                            style="padding: 0.6rem 1.2rem; background: #25D366; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        ‚úèÔ∏è Editar
                    </button>
                </div>
            </div>
        `;
        
        showModal(detailsHTML);
    }
}

function previewOnSite(productId) {
    const products = dashboard.getProducts();
    const product = products.find(p => p.id === productId);
    
    if (product) {
        alert(`üåê Preview do produto: ${product.nome}\n\nAbrindo visualiza√ß√£o do produto no estilo do site...`);
        // Aqui voc√™ pode implementar uma visualiza√ß√£o mais elaborada depois
    }
}

function exportAllProducts() {
    const products = dashboard.getProducts();
    const exportData = {
        produtos: products,
        total: products.length,
        dataExportacao: new Date().toISOString(),
        categorias: [...new Set(products.map(p => p.categoria))]
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `export_produtos_completo_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    alert(`üì§ Exportado ${products.length} produtos!`);
}

function showModal(html) {
    const modal = document.createElement('div');
    modal.id = 'detailsModal';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); display: flex; justify-content: center; 
        align-items: center; z-index: 2000; padding: 2rem;
    `;
    modal.innerHTML = html;
    document.body.appendChild(modal);
}

function closeModal() {
    const modal = document.getElementById('detailsModal');
    if (modal) modal.remove();
}

function adicionarProduto() {
    showAddProductModal();
}

function gerenciarCategorias() {
    alert('üéØ Gerenciar Categorias\n\nFuncionalidade em desenvolvimento...');
}

function verEstatisticas() {
    const products = dashboard.getProducts();
    const totalPreco = products.reduce((sum, p) => sum + (parseFloat(p.preco) || 0), 0);
    const avgPreco = products.length > 0 ? totalPreco / products.length : 0;
    
    alert(`üìä Estat√≠sticas:\n\n‚Ä¢ Produtos: ${products.length}\n‚Ä¢ Valor Total: R$ ${totalPreco.toFixed(2)}\n‚Ä¢ Pre√ßo M√©dio: R$ ${avgPreco.toFixed(2)}`);
}

function backupDados() {
    const products = dashboard.getProducts();
    const backupData = {
        produtos: products,
        dataBackup: new Date().toISOString(),
        total: products.length
    };
    
    const dataStr = JSON.stringify(backupData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `backup_produtos_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    alert('üíæ Backup realizado!');
}

// Atualiza estat√≠sticas periodicamente
setInterval(() => {
    dashboard.loadStats();
}, 30000);
